@model MedShare.Models.Doacao

@{
    ViewData["Title"] = "Cadastrar Doação";
}

<h1>Cadastrar Doação</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <!-- enctype e method são obrigatórios -->
        <form asp-action="Create" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="NomeDoacao" class="control-label"></label>
                <input asp-for="NomeDoacao" class="form-control" />
                <span asp-validation-for="NomeDoacao" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="ValidadeDoacao" class="control-label"></label>
                <input asp-for="ValidadeDoacao" type="date" class="form-control" />
                <span asp-validation-for="ValidadeDoacao" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="QuantidadeDoacao" class="control-label"></label>
                <input asp-for="QuantidadeDoacao" class="form-control" />
                <span asp-validation-for="QuantidadeDoacao" class="text-danger"></span>
            </div>

            <!-- Upload da Foto -->
            <div class="form-group">
                <label asp-for="FotoDoacao" class="control-label"></label>
                <input asp-for="FotoDoacao" type="file" class="form-control" accept="image/*" onchange="previewImage(event, 'previewFoto')" />
                <span asp-validation-for="FotoDoacao" class="text-danger"></span>

                <!-- Mostra a imagem anterior (caso já tenha sido enviada) -->
                @if (!string.IsNullOrEmpty(Model.CaminhoFoto))
                {
                    <img src="@Model.CaminhoFoto" alt="Foto da doação" style="max-width:200px; margin-top:10px;" />
                }

                <!-- Mantém o caminho salvo -->
                <input type="hidden" asp-for="CaminhoFoto" />

                <!-- Prévia da nova imagem -->
                <img id="previewFoto" src="#" alt="Prévia da imagem" style="display:none; max-width:200px; margin-top:10px;" />
            </div>

            <!-- Upload da Receita -->
            <div class="form-group">
                <label asp-for="ReceitaDoacao" class="control-label"></label>
                <input asp-for="ReceitaDoacao" type="file" class="form-control" accept="image/*,.pdf" onchange="previewFile(event, 'previewReceita', 'linkReceita')" />
                <span asp-validation-for="ReceitaDoacao" class="text-danger"></span>

                <!-- Mostra o arquivo anterior (imagem ou PDF) -->
                @if (!string.IsNullOrEmpty(Model.CaminhoReceita))
                {
                    if (Model.CaminhoReceita.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
                    {
                        <a href="@Model.CaminhoReceita" target="_blank" class="btn btn-outline-primary btn-sm" style="margin-top:10px;">Visualizar PDF atual</a>
                    }
                    else
                    {
                        <img src="@Model.CaminhoReceita" alt="Receita" style="max-width:200px; margin-top:10px;" />
                    }
                }

                <!-- Mantém o caminho salvo entre posts -->
                <input type="hidden" asp-for="CaminhoReceita" />

                <!-- Prévia da nova receita -->
                <img id="previewReceita" src="#" alt="Prévia da receita" style="display:none; max-width:200px; margin-top:10px;" />
                <a id="linkReceita" href="#" target="_blank" class="btn btn-outline-primary btn-sm" style="display:none; margin-top:10px;">Visualizar PDF</a>
            </div>

            <div class="form-group">
                <label for="InstituicaoId">Instituição</label>
                <select asp-for="InstituicaoId" class="form-control">
                    <option value="" selected disabled>Selecione uma instituição</option>
                    @foreach (var inst in ViewBag.Instituicoes)
                    {
                        if (Model?.InstituicaoId == inst.InstituicaoId)
                        {
                            <option value="@inst.InstituicaoId" selected>
                                @inst.InstituicaoNome - @inst.InstituicaoEndereco
                            </option>
                        }
                        else
                        {
                            <option value="@inst.InstituicaoId">
                                @inst.InstituicaoNome - @inst.InstituicaoEndereco
                            </option>
                        }
                    }
                </select>
                <span asp-validation-for="InstituicaoId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Status" class="control-label"></label>
                <input class="form-control" value="@Model.Status.ToString()" readonly disabled />
            </div>

            <div class="form-group mt-3">
                <a asp-action="Index" class="btn btn-outline-primary">Voltar</a>
                <input type="submit" value="Cadastrar" class="btn btn-success" />
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // Pré-visualização da imagem da doação
        function previewImage(event, previewId) {
            const input = event.target;
            const preview = document.getElementById(previewId);

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Pré-visualização da receita (imagem ou PDF)
        function previewFile(event, imgId, linkId) {
            const file = event.target.files[0];
            const imgPreview = document.getElementById(imgId);
            const linkPreview = document.getElementById(linkId);

            if (!file) {
                imgPreview.style.display = 'none';
                linkPreview.style.display = 'none';
                return;
            }

            const fileType = file.type;
            if (fileType === "application/pdf") {
                imgPreview.style.display = 'none';
                linkPreview.style.display = 'block';
                linkPreview.href = URL.createObjectURL(file);
            } else if (fileType.startsWith("image/")) {
                linkPreview.style.display = 'none';
                const reader = new FileReader();
                reader.onload = function (e) {
                    imgPreview.src = e.target.result;
                    imgPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imgPreview.style.display = 'none';
                linkPreview.style.display = 'none';
                alert("Tipo de arquivo não suportado. Envie uma imagem ou PDF.");
            }
        }
    </script>
}
